# Since we want to group by visited_on and capture all amounts during that date
with daily_amounts as (
    select
        visited_on,
        SUM(amount) as total_amount
    from 
        Customer
    group by 
        visited_on
),
# When I calc the rolling average without a join or cte, it does not calc correctly
rolling_window AS (
    SELECT
        visited_on,
        SUM(total_amount) over (
            order by visited_on
            rows between 6 preceding and current row
        ) as amount,
        round(avg(total_amount) over (
            order by visited_on
            rows between 6 preceding and current row
        ),2) as average_amount,
        row_number() over (order by visited_on) as rn
    from daily_amounts
)

# Here, we combine the two CTEs and this way we get above our rolling average date and window functions properly
select 
    visited_on,
    amount,
    average_amount
from
    rolling_window
where
    rn >= 7
order by
    visited_on;
